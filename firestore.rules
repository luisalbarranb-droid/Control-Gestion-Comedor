rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- User Data Rules ---
    // Users can read their own profile.
    // Admins/Superadmins can read any profile and list all users.
    match /users/{userId} {
      function isOwner() {
        return request.auth.uid == userId;
      }
      function isAdmin() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
      }

      allow get: if request.auth != null && (isOwner() || isAdmin());
      allow list: if request.auth != null && isAdmin();
      allow write: if request.auth != null && (isOwner() || isAdmin());
    }

    // --- Area Management Rules ---
    // Any authenticated user can read areas.
    // Only Admins/Superadmins can create, update, or delete them.
    match /areas/{areaId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // --- Task Management Rules ---
    // Authenticated users can interact with tasks based on more specific rules
    // (e.g., assignee, creator, admin of the area). For now, allow read/write for any authenticated user.
    match /tasks/{taskId} {
      allow read, write: if request.auth != null;
    }

    // --- Statistics Rules ---
    // Only Admins and Superadmins can read or write statistics.
    match /statistics/{period} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }
    
    // --- Configuration Rules ---
    // Public read for authenticated users, write access for Superadmins only.
    match /configuration/{configId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // --- Inventory Rules ---
    // All authenticated users can read inventory.
    // Only Admins/Superadmins can write to inventory.
    match /inventory/{itemId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }
    
    // --- Menu Rules ---
    // All authenticated users can read menus.
    // Only Admins/Superadmins can write to menus.
    match /menus/{menuId} {
       allow read: if request.auth != null;
       allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // --- Attendance and HR Rules ---
    // Only Admins/Superadmins can manage attendance, days off, and evaluations.
    match /attendance/{recordId} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }
    
    match /daysOff/{dayOffId} {
       allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // --- Evaluation Criteria Rules ---
    // Any authenticated user can read/list criteria.
    // Only Admins/Superadmins can write.
    match /evaluationCriteria/{criterionId} {
      allow get, list: if request.auth != null;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // --- Monthly Evaluation Rules ---
    // Users can read their own evaluation.
    // Admins/Superadmins can read any evaluation and list/write all.
    match /monthlyEvaluations/{evaluationId} {
      allow get: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'] || resource.data.userId == request.auth.uid);
      allow list, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }
    
    // --- Peer Review Rules ---
    // Any authenticated user can create a review.
    // Users can read reviews they've made or received.
    // Admins can read all reviews.
    match /peer-reviews/{reviewId} {
        allow create: if request.auth != null;
        allow read: if request.auth != null && (resource.data.reviewerId == request.auth.uid || resource.data.revieweeId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']);
        // Update/Delete rules can be added here if necessary
    }


    // --- Default Deny ---
    // Fallback rule to deny access to any other collections.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
