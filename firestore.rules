rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    // Simplificado para el desarrollo: cualquier usuario autenticado es tratado como admin.
    // Esto evita errores de permisos mientras no se implemente la asignación de roles.
    function isAdmin() {
      return isAuthenticated();
    }
    
    function isSuperAdmin() {
      // Por ahora, cualquier admin es superadmin para simplificar.
      return isAdmin();
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- User Data Rules ---
    // Un usuario puede leer y actualizar su propio perfil.
    // Un "admin" (cualquier usuario autenticado) puede listar y crear usuarios.
    match /users/{userId} {
      allow get, update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow list, create, delete: if isAdmin();
    }

    // --- Area Management Rules ---
    // Cualquier usuario autenticado puede leer áreas.
    // Solo "admins" pueden escribir.
    match /areas/{areaId} {
      allow get, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Task Management Rules ---
    // Simplificado por ahora: cualquier usuario autenticado puede crear, leer y actualizar tareas.
    // Solo "admins" pueden borrar.
    match /tasks/{taskId} {
      allow create, read, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // --- Statistics Rules ---
    // Solo "admins" pueden leer o escribir estadísticas.
    match /statistics/{period} {
      allow read, write: if isAdmin();
    }
    
    // --- Configuration Rules ---
    // Lectura pública para usuarios autenticados, escritura solo para "superadmins".
    match /configuration/{configId} {
      allow get, list: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // --- Inventory Rules ---
    // Todos los usuarios autenticados pueden leer, "admins" pueden escribir.
    match /inventory/{itemId} {
      allow get, list: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // --- Menu Rules ---
    // Todos los usuarios autenticados pueden leer, "admins" pueden escribir.
    match /menus/{menuId} {
       allow get, list: if isAuthenticated();
       allow write: if isAdmin();
    }

    // --- Attendance and HR Rules ---
    // El usuario puede leer sus propios registros, "admins" pueden leer/escribir todos.
    match /attendance/{recordId} {
      allow get: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow list, write: if isAdmin();
    }
    
    match /daysOff/{dayOffId} {
       allow get: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
       allow list, write: if isAdmin();
    }

    // --- Evaluation Criteria Rules ---
    // Cualquier usuario autenticado puede leer/listar, "admins" pueden escribir.
    match /evaluationCriteria/{criterionId} {
      allow get, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Monthly Evaluation Rules ---
    // El usuario puede leer su propia evaluación, "admins" pueden leer/escribir todas.
    match /monthlyEvaluations/{evaluationId} {
      allow get: if isAuthenticated() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow list, write: if isAdmin();
    }
    
    // --- Peer Review Rules ---
    // Cualquier usuario autenticado puede crear.
    // Los usuarios pueden leer las revisiones que hicieron o recibieron.
    match /peer-reviews/{reviewId} {
        allow create: if isAuthenticated();
        allow read: if isAuthenticated() && (resource.data.reviewerId == request.auth.uid || resource.data.revieweeId == request.auth.uid || isAdmin());
    }
  }
}
