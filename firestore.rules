rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      // Use custom claims for role checks - this is faster and more secure.
      return request.auth.token.role in ['admin', 'superadmin'];
    }

    // --- User Data Rules ---
    // Users can read/update their own profile.
    // Admins can read any profile and list all users.
    match /users/{userId} {
      allow get, update: if request.auth != null && (isOwner(userId) || isAdmin());
      allow list, create, delete: if request.auth != null && isAdmin();
    }

    // --- Area Management Rules ---
    // Any authenticated user can read areas.
    // Only Admins/Superadmins can create, update, or delete them.
    match /areas/{areaId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }

    // --- Task Management Rules ---
    // More granular rules should be added here later based on roles and assignments.
    // For now, allow read/write for any authenticated user.
    match /tasks/{taskId} {
      allow read, write: if request.auth != null;
    }

    // --- Statistics Rules ---
    // Only Admins and Superadmins can read or write statistics.
    match /statistics/{period} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // --- Configuration Rules ---
    // Public read for authenticated users, write access for Superadmins only.
    match /configuration/{configId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // --- Inventory Rules ---
    // All authenticated users can read inventory.
    // Only Admins/Superadmins can write to inventory.
    match /inventory/{itemId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }
    
    // --- Menu Rules ---
    // All authenticated users can read menus.
    // Only Admins/Superadmins can write to menus.
    match /menus/{menuId} {
       allow read: if request.auth != null;
       allow write: if request.auth != null && isAdmin();
    }

    // --- Attendance and HR Rules ---
    // Only Admins/Superadmins can manage attendance, days off, and evaluations.
    match /attendance/{recordId} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    match /daysOff/{dayOffId} {
       allow read, write: if request.auth != null && isAdmin();
    }

    // --- Evaluation Criteria Rules ---
    // Any authenticated user can read/list criteria.
    // Only Admins/Superadmins can write.
    match /evaluationCriteria/{criterionId} {
      allow get, list: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }

    // --- Monthly Evaluation Rules ---
    // Users can read their own evaluation.
    // Admins/Superadmins can read any evaluation and list/write all.
    match /monthlyEvaluations/{evaluationId} {
      allow get: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
      allow list, write: if request.auth != null && isAdmin();
    }
    
    // --- Peer Review Rules ---
    // Any authenticated user can create a review.
    // Users can read reviews they've made or received.
    // Admins can read all reviews.
    match /peer-reviews/{reviewId} {
        allow create: if request.auth != null;
        allow read: if request.auth != null && (resource.data.reviewerId == request.auth.uid || resource.data.revieweeId == request.auth.uid || isAdmin());
        // Update/Delete rules can be added here if necessary
    }
  }
}

    