rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      // Use custom claims for role checks - this is faster and more secure.
      return request.auth.token.role in ['admin', 'superadmin'];
    }
    
    function isSuperAdmin() {
      return request.auth.token.role == 'superadmin';
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // --- User Data Rules ---
    // Users can read/update their own profile.
    // Admins can read any profile and list all users.
    match /users/{userId} {
      allow get, update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow list, create, delete: if isAuthenticated() && isAdmin();
    }

    // --- Area Management Rules ---
    // Any authenticated user can read areas.
    // Only Admins/Superadmins can create, update, or delete them.
    match /areas/{areaId} {
      allow get, list: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }

    // --- Task Management Rules ---
    // Granular rules:
    // - Any authenticated user can create tasks.
    // - Users can read/update tasks assigned to them or created by them.
    // - Admins can read/update/delete any task.
    match /tasks/{taskId} {
      allow create, read, update: if isAuthenticated(); // Simplified for now
      allow delete: if isAuthenticated() && isAdmin();
    }

    // --- Statistics Rules ---
    // Only Admins and Superadmins can read or write statistics.
    match /statistics/{period} {
      allow read, write: if isAuthenticated() && isAdmin();
    }
    
    // --- Configuration Rules ---
    // Public read for authenticated users, write access for Superadmins only.
    match /configuration/{configId} {
      allow get, list: if isAuthenticated();
      allow write: if isAuthenticated() && isSuperAdmin();
    }

    // --- Inventory Rules ---
    // All authenticated users can read inventory.
    // Only Admins/Superadmins can write to inventory.
    match /inventory/{itemId} {
      allow get, list: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // --- Menu Rules ---
    // All authenticated users can read menus.
    // Only Admins/Superadmins can write to menus.
    match /menus/{menuId} {
       allow get, list: if isAuthenticated();
       allow write: if isAuthenticated() && isAdmin();
    }

    // --- Attendance and HR Rules ---
    // User can read their own attendance, admin can read/write all.
    match /attendance/{recordId} {
      allow get: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow list, write: if isAuthenticated() && isAdmin();
    }
    
    // User can read their own day off, admin can read/write all.
    match /daysOff/{dayOffId} {
       allow get: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
       allow list, write: if isAuthenticated() && isAdmin();
    }

    // --- Evaluation Criteria Rules ---
    // Any authenticated user can read/list criteria.
    // Only Admins/Superadmins can write.
    match /evaluationCriteria/{criterionId} {
      allow get, list: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }

    // --- Monthly Evaluation Rules ---
    // Users can read their own evaluation.
    // Admins/Superadmins can read any evaluation and list/write all.
    match /monthlyEvaluations/{evaluationId} {
      allow get: if isAuthenticated() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow list, write: if isAuthenticated() && isAdmin();
    }
    
    // --- Peer Review Rules ---
    // Any authenticated user can create a review.
    // Users can read reviews they've made or received.
    // Admins can read all reviews.
    match /peer-reviews/{reviewId} {
        allow create: if isAuthenticated();
        allow read: if isAuthenticated() && (resource.data.reviewerId == request.auth.uid || resource.data.revieweeId == request.auth.uid || isAdmin());
        // Update/Delete rules can be added here if necessary
    }
  }
}
